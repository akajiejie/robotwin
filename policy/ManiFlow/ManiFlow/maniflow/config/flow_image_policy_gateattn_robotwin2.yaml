defaults:
  - task: demo_task_dual_image

name: train_maniflow_image_policy_gateattn_no_gate_decay
task_name: ${task.name}
shape_meta: ${task.shape_meta}
exp_name: "flow_image_gateattn_no_gate_decay_sim"  # ğŸ”¥ æ·»åŠ simæ ‡è¯†ï¼ŒåŒºåˆ†ä»¿çœŸå®éªŒ

horizon: 16
n_obs_steps: 2
n_action_steps: 16
n_latency_steps: 0
dataset_obs_steps: ${n_obs_steps}
keypoint_visible_rate: 1.0
obs_as_global_cond: true

policy:
  _target_: maniflow.policy.maniflow_image_policy.ManiFlowTransformerImagePolicy
  
  # ğŸ”¥ è§‚æµ‹ç¼–ç ç»´åº¦ï¼ˆå¿…é¡»ä¸obs_encoderè¾“å‡ºç»´åº¦ä¸€è‡´ï¼‰
  cond_dim: 768  # SigLIP ViT-Baseè¾“å‡ºç»´åº¦ï¼Œä¹Ÿæ˜¯proprioæŠ•å½±åçš„ç»´åº¦
  
  # ğŸ”¥ğŸ”¥ğŸ”¥ Gate-Attention é…ç½® - å…³é—­Gateå‚æ•°çš„Weight Decayå®éªŒ ğŸ”¥ğŸ”¥ğŸ”¥
  use_gate_attn: true       # å¯ç”¨ Gate-Attention æœºåˆ¶ï¼ˆä½¿ç”¨DiTXGateAttnï¼‰
  gate_type: "headwise"     # Gate-Attentionç±»å‹: 'none', 'headwise', 'elementwise'
                            # - 'none': æ ‡å‡†cross-attentionï¼ˆæ— gateï¼‰
                            # - 'headwise': æ¯ä¸ªæ³¨æ„åŠ›å¤´ä¸€ä¸ªgateå€¼ï¼ˆè½»é‡çº§ï¼‰â­ å½“å‰ä½¿ç”¨
                            # - 'elementwise': æ¯ä¸ªå…ƒç´ ä¸€ä¸ªgateå€¼ï¼ˆæœ€ç»†ç²’åº¦ï¼Œå‚è€ƒQwen3ï¼‰
  block_type: "DiTX"        # ä¿ç•™æ­¤å‚æ•°ä»¥ä¿æŒå‘åå…¼å®¹æ€§
  
  # æ¶æ„é…ç½®
  n_layer: 12
  n_head: 8
  n_emb: 768
  
  # ğŸ”¥ğŸ”¥ğŸ”¥ Head-Proprioèåˆç­–ç•¥åçš„Tokenç»„ç»‡ï¼ˆä»¿çœŸç¯å¢ƒ-çº¯è§†è§‰ï¼‰ï¼š
  #    è¾“å‡ºæ ¼å¼: (B, L_total, D)ï¼Œå…¶ä¸­ L_total = æ‰€æœ‰æ¨¡æ€çš„tokenæ•°ï¼ˆå·²å±•å¼€æ—¶é—´æ­¥ï¼‰
  #    
  #    Tokenç»„ç»‡ç»“æ„ï¼ˆæŒ‰æ¨¡æ€åˆ†ç»„ï¼Œæ¯ä¸ªæ¨¡æ€å†…æŒ‰æ—¶é—´æ­¥æ’åˆ—ï¼‰ï¼š
  #    - headæ¨¡æ€ (head_grid_size=1, **å·²èåˆproprio**):  [head_t0_token(å«proprio), head_t1_token(å«proprio)] = 2 tokens
  #    - rgb_wristæ¨¡æ€: [L_wrist_t0, L_wrist_t1, R_wrist_t0, R_wrist_t1] = 4 tokens
  #    - **proprioæ¨¡æ€: å·²èåˆè¿›headï¼Œä¸å†ä½œä¸ºç‹¬ç«‹tokenè¾“å‡º**
  #    
  #    æ€»tokenæ•°: L_total = 2 + 4 = 6 (Headå«proprio + Wristï¼Œæ— è§¦è§‰)
  #    
  # ğŸ”¥ DiTXä½ç½®ç¼–ç é…ç½®:
  #    self.vis_cond_pos_embed = nn.Parameter(torch.zeros(1, visual_cond_len * n_obs_steps, n_emb))
  #    æ‰€ä»¥éœ€è¦: visual_cond_len Ã— n_obs_steps = L_total
  #    å³: visual_cond_len = L_total / n_obs_steps = 6 / 2 = 3
  visual_cond_len: 3  # æ¯ä¸ªæ—¶é—´æ­¥çš„æ¨¡æ€tokenæ•°ï¼ˆDiTXå†…éƒ¨ä¼š Ã— n_obs_steps = 2 å¾—åˆ°6ä¸ªä½ç½®ç¼–ç ï¼‰
  
  max_lang_cond_len: 1024
  qkv_bias: true
  qk_norm: true
  language_conditioned: false
  pre_norm_modality: false

  flow_batch_ratio: 0.75 
  consistency_batch_ratio: 0.25
  sample_t_mode_flow: "beta"
  sample_t_mode_consistency: "discrete" 
  sample_dt_mode_consistency: "uniform"
  sample_target_t_mode: "relative"
  denoise_timesteps: 10
  diffusion_timestep_embed_dim: 128
  diffusion_target_t_embed_dim: 128
  horizon: ${horizon}
  n_action_steps: ${n_action_steps}
  n_obs_steps: ${n_obs_steps}
  num_inference_steps: 10
  obs_as_global_cond: true
  shape_meta: ${shape_meta}

  obs_encoder:
    _target_: maniflow.model.vision_2d.timm_multimodal_encoder.TimmMultimodalEncoder
    shape_meta: ${shape_meta}
    
    ##### RGBç›¸æœºé…ç½® (SigLIP) #####
    model_name: 'vit_base_patch16_siglip_224'
    pretrained: true
    frozen: false
    global_pool: ''
    head_grid_size: 1  # è®¾ç½®ä¸º1ä»£è¡¨è¾“å‡º1ä¸ªtokenï¼ˆå…¨å±€ç‰¹å¾ï¼‰ï¼Œè®¾ç½®ä¸º6ä»£è¡¨è¾“å‡º6x6=36ä¸ªtokensï¼ˆä¿ç•™æ›´å¤šç©ºé—´ä¿¡æ¯ï¼‰
    feature_aggregation: 'avg' # å…¶ä»–ç›¸æœºï¼ˆå¦‚è…•éƒ¨ï¼‰ä¾ç„¶ç»´æŒ1ä¸ªtoken
    downsample_ratio: 32
    
    ##### è§¦è§‰ä¼ æ„Ÿå™¨é…ç½® - ä»¿çœŸç¯å¢ƒä¸ä½¿ç”¨ï¼Œå·²æ³¨é‡Š #####
    # tactile_model_name: 'resnet18'
    # tactile_pretrained: false
    # tactile_frozen: false
    # tactile_feature_dim: 768   # ä¸RGBç‰¹å¾ç»´åº¦ä¸€è‡´ï¼ˆSigLIP baseä¸º768ï¼‰
    # tactile_num_kp: 32         # ğŸ†• SpatialSoftmaxå…³é”®ç‚¹æ•°é‡ï¼ˆä¸robomimicä¸€è‡´ï¼‰
    # tactile_crop_shape: null   # ğŸ†• è§¦è§‰è£å‰ªå°ºå¯¸ï¼Œnullè¡¨ç¤ºä¸è£å‰ªï¼ˆå¯è®¾ä¸º[56, 112]ï¼‰
    # share_tactile_model: true
    # tactile_output_all_patches: false  # æ”¹ä¸ºfalseï¼Œæ¯ä¸ªè§¦è§‰ä¼ æ„Ÿå™¨æ¯æ—¶é—´æ­¥è¾“å‡º1ä¸ªtoken
    
    #####è¾“å‡ºtokenåºåˆ—æ¨¡å¼ #####
    output_token_sequence: true
    
    transforms:
      - type: RandomCrop
        ratio: 0.85
      - _target_: torchvision.transforms.RandomRotation
        degrees: [-5.0, 5.0]
        expand: false
      - _target_: torchvision.transforms.ColorJitter
        brightness: 0.4
        contrast: 0.5
        saturation: 0.5
        hue: 0.08
     
    use_group_norm: false
    share_rgb_model: false
    imagenet_norm: true

ema:
  _target_: maniflow.model.diffusion.ema_model.EMAModel
  update_after_step: 0
  inv_gamma: 1.0
  power: 0.75
  min_value: 0.0
  max_value: 0.9999

dataloader:
  batch_size: 64      
  num_workers: 8
  shuffle: True
  pin_memory: True
  persistent_workers: True

val_dataloader:
  batch_size: 64
  num_workers: 4
  shuffle: False
  pin_memory: True
  persistent_workers: False

# ğŸ”¥ğŸ”¥ğŸ”¥ ä¼˜åŒ–å™¨é…ç½® - Gateå‚æ•°å…é™¤Weight Decayå®éªŒ ğŸ”¥ğŸ”¥ğŸ”¥
# æ ¸å¿ƒæ”¹åŠ¨ï¼šget_optim_groups å‡½æ•°å·²è‡ªåŠ¨å°†ä»¥ä¸‹å‚æ•°æ’é™¤åœ¨weight_decayä¹‹å¤–ï¼š
#   1. cross_attn.q.weight / cross_attn.q.bias (ç”Ÿæˆgate scoreçš„æ ¸å¿ƒ)
#   2. _modality_bias_tensor (æ¨¡æ€ç‰¹å®šçš„gateåˆå§‹åŒ–åç½®)
#   3. ä»»ä½•åŒ…å«"gate"å…³é”®è¯çš„å‚æ•°
# 
# å®éªŒå¯¹æ¯”ç»„ï¼š
#   - åŸºçº¿ç»„ï¼ˆåŸå§‹é…ç½®ï¼‰: weight_decay=1.0e-4ï¼Œæ‰€æœ‰å‚æ•°éƒ½å—æƒ©ç½š
#   - å®éªŒç»„ï¼ˆæœ¬é…ç½®ï¼‰: weight_decay=1.0e-4ï¼Œä½†Gateå‚æ•°è¢«è‡ªåŠ¨ä¿æŠ¤
optimizer:
  _target_: torch.optim.AdamW
  lr: 2.0e-4
  betas: [0.9, 0.95]
  eps: 1.0e-8
  weight_decay: 1.0e-4  # ğŸ”¥ ä¿æŒç›¸åŒçš„weight_decayå€¼ï¼Œä½†Gateå‚æ•°ä¼šè¢«è‡ªåŠ¨æ’é™¤

training:
  device: "cuda:0"
  env_device: "cuda:0"
  seed: 42
  debug: False
  resume: True
  lr_scheduler: cosine
  lr_warmup_steps: 500
  num_epochs: 301
  gradient_accumulate_every: 1
  use_wandb: true
  max_grad_norm: 5.0
  use_ema: True  
  rollout_every: 100
  checkpoint_every: 50
  val_every: 50
  sample_every: 5
  max_train_steps: null
  max_val_steps: null
  tqdm_interval_sec: 1.0
  
  # ğŸ”¥ğŸ”¥ğŸ”¥ Head-Proprioèåˆç­–ç•¥åçš„æ¨¡æ€Dropé…ç½®
  # è®¾è®¡ç†å¿µï¼šæ¨¡æ‹ŸçœŸå®æœºå™¨äººæ“ä½œä¸­çš„ä¼ æ„Ÿå™¨å¤±æ•ˆåœºæ™¯ï¼Œæå‡æ¨¡å‹é²æ£’æ€§
  # **é‡è¦å˜åŒ–ï¼šProprioå·²èåˆè¿›Headï¼ŒDrop Headä¼šåŒæ—¶Dropæœ¬ä½“æ„ŸçŸ¥ä¿¡æ¯**
  modality_drop:
    enabled: true
    head_drop: 0.1         # 20%æ¦‚ç‡Dropå¤´éƒ¨ç›¸æœºï¼ˆ**åŒæ—¶Dropèåˆçš„proprioä¿¡æ¯**ï¼‰
    rgb_wrist_drop: 0.02   # 5%æ¦‚ç‡Dropè…•éƒ¨ç›¸æœºï¼ˆè¿‘è·ç¦»è§†è§’ï¼Œä¸æ˜“é®æŒ¡ï¼‰
    # tactile_drop: 0.0    # ğŸ”¥ ä»¿çœŸç¯å¢ƒæ— è§¦è§‰ï¼Œå·²ç§»é™¤
    # proprio_drop: 0.5    # ğŸ”¥ğŸ”¥ğŸ”¥ å·²åºŸå¼ƒï¼šProprioå·²èåˆè¿›Headï¼Œä¸å†ä½œä¸ºç‹¬ç«‹å‚æ•°

logging:
  group: ${exp_name}
  id: null
  mode: online
  name: ${training.seed}_head_proprio_fusion_sim
  project: ManiFlow_Image_GateAttn_Sim  # ğŸ”¥ ä¿®æ”¹é¡¹ç›®åï¼ŒåŒºåˆ†ä»¿çœŸå®éªŒ
  resume: false
  tags:
  - ${logging.project}
  - ditx_gateattn
  - gate_attention
  - vision_only        # ğŸ”¥ æ–°å¢æ ‡ç­¾ï¼šçº¯è§†è§‰
  - no_tactile         # ğŸ”¥ æ–°å¢æ ‡ç­¾ï¼šæ— è§¦è§‰
  - sim                # ğŸ”¥ æ–°å¢æ ‡ç­¾ï¼šä»¿çœŸç¯å¢ƒ
  - headwise_gate
  - no_gate_decay      # ğŸ”¥ Gateå‚æ•°å…é™¤weight decayå®éªŒ
  - head_proprio_fusion  # ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢æ ‡ç­¾ï¼šHead-Proprioèåˆç­–ç•¥

checkpoint:
  save_ckpt: True
  topk:
    monitor_key: val_loss
    mode: min
    k: 1
    format_str: 'epoch={epoch:04d}-val_loss={val_loss:.6f}.ckpt'
  
  save_last_ckpt: True
  save_last_snapshot: False
  save_every: 50

multi_run:
  run_dir: data/outputs/${now:%Y.%m.%d}/${now:%H.%M.%S}_${name}_${task_name}
  wandb_name_base: ${now:%Y.%m.%d-%H.%M.%S}_${name}_${task_name}

hydra:
  job:
    override_dirname: ${name}
  run:
    dir: data/outputs/${now:%Y.%m.%d}/${now:%H.%M.%S}_${name}_${task_name}
  sweep:
    dir: data/outputs/${now:%Y.%m.%d}/${now:%H.%M.%S}_${name}_${task_name}
    subdir: ${hydra.job.num}

checkpoint_num: 500
expert_data_num: 50
raw_task_name: none
setting: none
