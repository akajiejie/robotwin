defaults:
  - task: demo_task_tactile

name: train_maniflow_tactile_image_policy_gateattn
task_name: ${task.name}
shape_meta: ${task.shape_meta}
exp_name: "flow_tactile_image_gateattn"

horizon: 32
n_obs_steps: 2
n_action_steps: 32
n_latency_steps: 0
dataset_obs_steps: ${n_obs_steps}
keypoint_visible_rate: 1.0
obs_as_global_cond: true

policy:
  _target_: maniflow.policy.maniflow_image_policy.ManiFlowTransformerImagePolicy
  
  # ğŸ”¥ è§‚æµ‹ç¼–ç ç»´åº¦ï¼ˆå¿…é¡»ä¸obs_encoderè¾“å‡ºç»´åº¦ä¸€è‡´ï¼‰
  cond_dim: 768  # SigLIP ViT-Baseè¾“å‡ºç»´åº¦ï¼Œä¹Ÿæ˜¯tactileå’ŒproprioæŠ•å½±åçš„ç»´åº¦
  
  # Gate-Attention é…ç½®
  use_gate_attn: true       # å¯ç”¨ Gate-Attention æœºåˆ¶ï¼ˆä½¿ç”¨DiTXGateAttnï¼‰
  gate_type: "headwise"  # Gate-Attentionç±»å‹: 'none', 'headwise', 'elementwise'
                            # - 'none': æ ‡å‡†cross-attentionï¼ˆæ— gateï¼‰
                            # - 'headwise': æ¯ä¸ªæ³¨æ„åŠ›å¤´ä¸€ä¸ªgateå€¼ï¼ˆè½»é‡çº§ï¼‰
                            # - 'elementwise': æ¯ä¸ªå…ƒç´ ä¸€ä¸ªgateå€¼ï¼ˆæœ€ç»†ç²’åº¦ï¼Œå‚è€ƒQwen3ï¼‰
  block_type: "DiTX"        # ä¿ç•™æ­¤å‚æ•°ä»¥ä¿æŒå‘åå…¼å®¹æ€§
  
  # æ¶æ„é…ç½®
  n_layer: 12
  n_head: 8
  n_emb: 768
  
  # ğŸ”¥ TimmMultimodalEncoder åœ¨ output_token_sequence=True æ¨¡å¼ä¸‹çš„è¾“å‡ºï¼š
  #    è¾“å‡ºæ ¼å¼: (B, L_total, D)ï¼Œå…¶ä¸­ L_total = æ‰€æœ‰æ¨¡æ€çš„tokenæ•°ï¼ˆå·²å±•å¼€æ—¶é—´æ­¥ï¼‰
  #    
  #    Tokenç»„ç»‡ç»“æ„ï¼ˆæŒ‰æ¨¡æ€åˆ†ç»„ï¼Œæ¯ä¸ªæ¨¡æ€å†…æŒ‰æ—¶é—´æ­¥æ’åˆ—ï¼‰ï¼š
  #    - headæ¨¡æ€:      [head_cam_t0, head_cam_t1]           = 2 tokens
  #    - rgb_wristæ¨¡æ€: [L_wrist_t0, L_wrist_t1, R_wrist_t0, R_wrist_t1] = 4 tokens
  #    - tactileæ¨¡æ€:   [L_tactile_t0, L_tactile_t1, R_tactile_t0, R_tactile_t1] = 4 tokens
  #    - proprioæ¨¡æ€:   [proprio_t0, proprio_t1]             = 2 tokens
  #    
  #    æ€»tokenæ•°: L_total = 2 + 4 + 4 + 2 = 12
  #    
  # ğŸ”¥ DiTXä½ç½®ç¼–ç é…ç½®:
  #    self.vis_cond_pos_embed = nn.Parameter(torch.zeros(1, visual_cond_len * n_obs_steps, n_emb))
  #    æ‰€ä»¥éœ€è¦: visual_cond_len Ã— n_obs_steps = L_total
  #    å³: visual_cond_len = L_total / n_obs_steps = 12 / 2 = 6
  visual_cond_len: 6  # æ¯ä¸ªæ—¶é—´æ­¥çš„æ¨¡æ€æ•°ï¼ˆDiTXå†…éƒ¨ä¼š Ã— n_obs_steps = 2 å¾—åˆ°12ä¸ªä½ç½®ç¼–ç ï¼‰
  
  max_lang_cond_len: 1024
  qkv_bias: true
  qk_norm: true
  language_conditioned: false
  pre_norm_modality: false

  flow_batch_ratio: 0.75 
  consistency_batch_ratio: 0.25
  sample_t_mode_flow: "beta"
  sample_t_mode_consistency: "discrete" 
  sample_dt_mode_consistency: "uniform"
  sample_target_t_mode: "relative"
  denoise_timesteps: 10
  diffusion_timestep_embed_dim: 128
  diffusion_target_t_embed_dim: 128
  horizon: ${horizon}
  n_action_steps: ${n_action_steps}
  n_obs_steps: ${n_obs_steps}
  num_inference_steps: 10
  obs_as_global_cond: true
  shape_meta: ${shape_meta}

  obs_encoder:
    _target_: maniflow.model.vision_2d.timm_multimodal_encoder.TimmMultimodalEncoder
    shape_meta: ${shape_meta}
    
    ##### RGBç›¸æœºé…ç½® (SigLIP) #####
    model_name: 'vit_base_patch16_siglip_224'
    pretrained: true
    frozen: false
    global_pool: ''
    feature_aggregation: 'avg'  # ä½¿ç”¨avgèšåˆï¼Œæ¯ä¸ªç›¸æœºè¾“å‡º1ä¸ªtoken
    downsample_ratio: 32
    
    ##### è§¦è§‰ä¼ æ„Ÿå™¨é…ç½® #####
    tactile_model_name: 'resnet18'
    tactile_pretrained: false
    tactile_frozen: false
    tactile_feature_dim: 768   # ä¸RGBç‰¹å¾ç»´åº¦ä¸€è‡´ï¼ˆSigLIP baseä¸º768ï¼‰
    tactile_num_kp: 32         # ğŸ†• SpatialSoftmaxå…³é”®ç‚¹æ•°é‡ï¼ˆä¸robomimicä¸€è‡´ï¼‰
    tactile_crop_shape: null   # ğŸ†• è§¦è§‰è£å‰ªå°ºå¯¸ï¼Œnullè¡¨ç¤ºä¸è£å‰ªï¼ˆå¯è®¾ä¸º[56, 112]ï¼‰
    share_tactile_model: true
    tactile_output_all_patches: false  # æ”¹ä¸ºfalseï¼Œæ¯ä¸ªè§¦è§‰ä¼ æ„Ÿå™¨æ¯æ—¶é—´æ­¥è¾“å‡º1ä¸ªtoken
    
    #####è¾“å‡ºtokenåºåˆ—æ¨¡å¼ #####
    output_token_sequence: true
    
    transforms:
      - type: RandomCrop
        ratio: 0.85
      - _target_: torchvision.transforms.RandomRotation
        degrees: [-5.0, 5.0]
        expand: false
      - _target_: torchvision.transforms.ColorJitter
        brightness: 0.4
        contrast: 0.5
        saturation: 0.5
        hue: 0.08
     
    use_group_norm: false
    share_rgb_model: false
    imagenet_norm: true

ema:
  _target_: maniflow.model.diffusion.ema_model.EMAModel
  update_after_step: 0
  inv_gamma: 1.0
  power: 0.75
  min_value: 0.0
  max_value: 0.9999

dataloader:
  batch_size: 112      
  num_workers: 8
  shuffle: True
  pin_memory: True
  persistent_workers: True

val_dataloader:
  batch_size: 112
  num_workers: 4
  shuffle: False
  pin_memory: True
  persistent_workers: False

optimizer:
  _target_: torch.optim.AdamW
  lr: 2.0e-4
  betas: [0.9, 0.95]
  eps: 1.0e-8
  weight_decay: 1.0e-4

training:
  device: "cuda:0"
  env_device: "cuda:0"
  seed: 42
  debug: False
  resume: True
  lr_scheduler: cosine
  lr_warmup_steps: 500
  num_epochs: 301
  gradient_accumulate_every: 1
  use_wandb: true
  max_grad_norm: 5.0
  use_ema: True  
  rollout_every: 100
  checkpoint_every: 50
  val_every: 50
  sample_every: 5
  max_train_steps: null
  max_val_steps: null
  tqdm_interval_sec: 1.0
  
  # æ¨¡æ€Dropé…ç½®ï¼ˆè®­ç»ƒæ—¶æ•°æ®å¢å¼ºï¼Œæ¨ç†æ—¶è‡ªåŠ¨å…³é—­ï¼‰
  # è®¾è®¡ç†å¿µï¼šæ¨¡æ‹ŸçœŸå®æœºå™¨äººæ“ä½œä¸­çš„ä¼ æ„Ÿå™¨å¤±æ•ˆåœºæ™¯ï¼Œæå‡æ¨¡å‹é²æ£’æ€§
  modality_drop:
    head_drop: 0.15         # 25%æ¦‚ç‡Dropå¤´éƒ¨ç›¸æœºï¼ˆæ¨¡æ‹Ÿè¢«æœºæ¢°è‡‚é®æŒ¡ï¼‰
    rgb_wrist_drop: 0.05    # 5%æ¦‚ç‡Dropè…•éƒ¨ç›¸æœºï¼ˆè¿‘è·ç¦»è§†è§’ï¼Œä¸æ˜“é®æŒ¡ï¼‰
    tactile_drop: 0.0       # ä¿ç•™è§¦è§‰ï¼ˆæ¥è§¦ä¿¡æ¯æ˜¯å…œåº•ä¿éšœï¼‰
    proprio_drop: 0.15      # 15%æ¦‚ç‡Dropæœ¬ä½“æ„ŸçŸ¥ï¼ˆå¼ºåˆ¶å­¦ä¹ è§†è§‰-è§¦è§‰ä¾èµ–ï¼‰

logging:
  group: ${exp_name}
  id: null
  mode: online
  name: ${training.seed}
  project: ManiFlow_Tactile_Image_GateAttn
  resume: false
  tags:
  - ${logging.project}
  - ditx_gateattn
  - gate_attention
  - tactile_rgb
  - elementwise_gate

checkpoint:
  save_ckpt: True
  topk:
    monitor_key: val_loss
    mode: min
    k: 1
    format_str: 'epoch={epoch:04d}-val_loss={val_loss:.6f}.ckpt'
  
  save_last_ckpt: True
  save_last_snapshot: False
  save_every: 50

multi_run:
  run_dir: data/outputs/${now:%Y.%m.%d}/${now:%H.%M.%S}_${name}_${task_name}
  wandb_name_base: ${now:%Y.%m.%d-%H.%M.%S}_${name}_${task_name}

hydra:
  job:
    override_dirname: ${name}
  run:
    dir: data/outputs/${now:%Y.%m.%d}/${now:%H.%M.%S}_${name}_${task_name}
  sweep:
    dir: data/outputs/${now:%Y.%m.%d}/${now:%H.%M.%S}_${name}_${task_name}
    subdir: ${hydra.job.num}

checkpoint_num: 500
expert_data_num: 50
raw_task_name: none
setting: none
